#!/usr/bin/env bash

# Hanif CLI - Personal productivity tool

set -euo pipefail

# Resolve symlink to find the actual script location
if [[ -L "$0" ]]; then
  SCRIPT_DIR="$(cd "$(dirname "$(readlink "$0")")" && pwd)"
else
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi

# Set up library path
LIB_DIR="${SCRIPT_DIR}/../lib"
COMMANDS_DIR="${LIB_DIR}/commands"
UTILS_DIR="${LIB_DIR}/utils"
FUNCTIONS_DIR="${LIB_DIR}/functions"

# Source common utilities
# shellcheck source=../lib/utils/common.sh
source "${UTILS_DIR}/common.sh"

# Source update check
# shellcheck source=../lib/utils/update-check.sh
source "${UTILS_DIR}/update-check.sh"

# CLI Version
VERSION="0.1.0"

# Main command dispatcher
main() {
  # Handle no arguments
  if [[ $# -eq 0 ]]; then
    show_usage
    exit 0
  fi

  local command="$1"
  shift

  case "$command" in
    # Git shortcut commands (preferred)
    # These are the primary way to use git commands.
    # TODO(deprecation): Remove `hanif git <subcommand>` form in v2.0.0
    sync)
      source "${COMMANDS_DIR}/git.sh"
      git_command sync "$@"
      ;;
    nf|newfeature)
      source "${COMMANDS_DIR}/git.sh"
      git_command nf "$@"
      ;;
    up|update)
      source "${COMMANDS_DIR}/git.sh"
      git_command up "$@"
      ;;
    upall|updateall)
      source "${COMMANDS_DIR}/git.sh"
      git_command upall "$@"
      ;;
    clean)
      source "${COMMANDS_DIR}/git.sh"
      git_command clean "$@"
      ;;
    rb|rebase)
      source "${COMMANDS_DIR}/git.sh"
      git_command rb "$@"
      ;;
    pull)
      source "${COMMANDS_DIR}/git.sh"
      git_command pull "$@"
      ;;
    st|status)
      source "${COMMANDS_DIR}/git.sh"
      git_command st "$@"
      ;;
    amend)
      source "${COMMANDS_DIR}/git.sh"
      git_command amend "$@"
      ;;

    # Backward-compatible `hanif git <subcommand>` form
    # TODO(deprecation): Remove in v2.0.0 — use `hanif <subcommand>` directly
    git)
      # shellcheck source=../lib/commands/git.sh
      source "${COMMANDS_DIR}/git.sh"
      git_command "$@"
      ;;

    squash)
      # shellcheck source=../lib/commands/squash.sh
      source "${COMMANDS_DIR}/squash.sh"
      squash_command "$@"
      ;;

    svg)
      # shellcheck source=../lib/commands/svg.sh
      source "${COMMANDS_DIR}/svg.sh"
      svg_command "$@"
      ;;

    help|--help|-h)
      # shellcheck source=../lib/commands/help.sh
      source "${COMMANDS_DIR}/help.sh"
      show_help "$@"
      ;;

    self-update)
      source "${FUNCTIONS_DIR}/update-functions.sh"
      self_update
      ;;

    version|--version|-v)
      echo "Hanif CLI v${VERSION}"
      ;;

    *)
      echo "❌ Unknown command: $command"
      echo ""
      show_usage
      exit 1
      ;;
  esac
}

# Show basic usage
show_usage() {
  cat << EOF
┌─────────────────────────────────────────────┐
│              Hanif CLI v${VERSION}$(printf '%*s' $((20 - ${#VERSION})) '')│
└─────────────────────────────────────────────┘

Simple, extensible CLI for daily workflows

Usage: hanif <command> [options]

Git Commands:
  sync                Full sync (update, rebase, clean)
  nf "description"    Create feature branch
  up                  Update main branch
  upall               Update all branches
  clean               Delete branches removed from remote
  rb <branch>         Rebase onto branch
  pull                Fetch all + pull
  st                  Git status
  amend ["message"]   Amend last commit with current changes
  squash [count]      Interactive commit squashing (default: 20)

Other Commands:
  svg <subcommand>    SVG to PNG conversion
  self-update         Update Hanif CLI to latest version
  help [command]      Show help
  version             Show version

Examples:
  hanif sync
  hanif nf "add feature"
  hanif up
  hanif squash 5
  hanif svg chrome icon.svg
  hanif help git
EOF
}

# Run main function
main "$@"

# Check for updates in background (non-blocking)
check_for_updates
